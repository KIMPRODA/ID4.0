<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <title>ì£¼í–‰ê±°ë¦¬ ë° ìœ ë¥˜ë¹„ ê³„ì‚°ê¸° (ë‹¤ì¤‘ ê²½ìœ ì§€)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Malgun Gothic', sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: #3EBBF0; padding: 20px; text-align: center; }
        .header h1 { color: white; font-size: 24px; }
        .content { display: flex; }
        .sidebar { width: 400px; padding: 20px; border-right: 1px solid #ddd; max-height: 800px; overflow-y: auto; }
        .map-area { flex: 1; position: relative; }
        #map { width: 100%; height: 800px; }
        .waypoint-group { margin-bottom: 10px; }
        .waypoint-item { display: flex; gap: 5px; margin-bottom: 5px; align-items: center; }
        .waypoint-item input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px; }
        .waypoint-item button { padding: 8px 12px; background: #ff5252; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .waypoint-item button:hover { background: #ff1744; }
        .waypoint-label { font-size: 12px; color: #666; font-weight: bold; min-width: 50px; }
        .btn { width: 100%; padding: 12px; background: #3EBBF0; border: none; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; color: white; }
        .btn:hover { background: #2BA5D8; }
        .btn-add { background: #4CAF50; margin-top: 5px; padding: 8px; font-size: 14px; }
        .btn-add:hover { background: #45a049; }
        .result { margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 5px; display: none; }
        .result h3 { margin-bottom: 10px; color: #333; font-size: 16px; }
        .route-detail { margin-bottom: 15px; padding: 10px; background: white; border-radius: 5px; border-left: 3px solid #3EBBF0; }
        .route-detail-title { font-weight: bold; color: #333; margin-bottom: 5px; font-size: 13px; }
        .route-detail-info { font-size: 12px; color: #666; }
        .total-summary { background: #3EBBF0; color: white; padding: 15px; border-radius: 5px; margin-top: 10px; }
        .total-summary-item { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px; }
        .total-summary-item:last-child { font-size: 18px; font-weight: bold; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 10px; margin-top: 10px; }
        .compare-card { background: white; padding: 12px; margin-bottom: 10px; border-radius: 5px; border-left: 4px solid #3EBBF0; cursor: pointer; transition: all 0.3s; }
        .compare-card:hover { background: #f0f8ff; transform: translateX(5px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .compare-card.active { background: #e3f2fd; border-left-color: #1976d2; border-left-width: 6px; }
        .compare-card h4 { margin-bottom: 8px; color: #333; font-size: 14px; }
        .compare-card p { margin: 4px 0; font-size: 13px; color: #666; }
        .compare-summary { background: #4CAF50; color: white; padding: 12px; border-radius: 5px; margin-top: 10px; font-size: 13px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš— ì£¼í–‰ê±°ë¦¬ ë° ìœ ë¥˜ë¹„ ê³„ì‚°ê¸° (ë‹¤ì¤‘ ê²½ìœ ì§€)</h1>
        </div>
        <div class="content">
            <div class="sidebar">
                <div class="waypoint-group">
                    <div class="waypoint-item">
                        <span class="waypoint-label">ì¶œë°œì§€</span>
                        <input type="text" id="start" placeholder="ì˜ˆ: ì„œìš¸ì‹œì²­">
                    </div>
                </div>
                
                <div id="waypointContainer"></div>
                
                <div class="waypoint-group">
                    <div class="waypoint-item">
                        <span class="waypoint-label">ë„ì°©ì§€</span>
                        <input type="text" id="end" placeholder="ì˜ˆ: ê°•ë‚¨ì—­">
                    </div>
                </div>
                
                <div class="input-group" style="margin-top: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">ê²½ë¡œ ì˜µì…˜</label>
                    <select id="routeOption" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                        <option value="COMPARE" selected>ì „ì²´ ë¹„êµ</option>
                        <option value="RECOMMEND">ì¶”ì²œ ê²½ë¡œ</option>
                        <option value="TIME">ë¹ ë¥¸ ê¸¸</option>
                        <option value="DISTANCE">ìµœë‹¨ ê±°ë¦¬</option>
                    </select>
                </div>
                
                <button class="btn btn-add" onclick="addWaypoint()">+ ê²½ìœ ì§€ ì¶”ê°€</button>
                <button class="btn" onclick="calculateRoute()">ê²½ë¡œ ê³„ì‚°í•˜ê¸°</button>
                
                <div class="result" id="result">
                    <h3>ğŸ“ êµ¬ê°„ë³„ ìƒì„¸ ì •ë³´</h3>
                    <div id="routeDetails"></div>
                    <div id="compareResults" style="display: none;"></div>
                    
                    <div class="total-summary">
                        <div class="total-summary-item">
                            <span>ì´ ê±°ë¦¬</span>
                            <span id="totalDistance">-</span>
                        </div>
                        <div class="total-summary-item">
                            <span>ì´ ì‹œê°„</span>
                            <span id="totalDuration">-</span>
                        </div>
                        <div class="total-summary-item">
                            <span>ì´ í†µí–‰ë£Œ</span>
                            <span id="totalToll">-</span>
                        </div>
                        <div class="total-summary-item">
                            <span>ì´ ìœ ë¥˜ë¹„</span>
                            <span id="totalFuelCost">-</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="map-area">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=2d6e24046010efdbfa9c002db0863a61"></script>
    <script>
        const API_KEY = 'd94166660f1d5b2b0669f82303f82cb6';
        const PRICE_PER_KM = 172;
        
        var map;
        var markers = [];
        var polylines = [];
        var waypointCount = 0;
        var currentCompareResults = null;
        var currentCoords = null;
        
        // ì¹´ì¹´ì˜¤ë§µ SDK ë¡œë”© ëŒ€ê¸°
        function initMap() {
            if (typeof kakao === 'undefined' || !kakao.maps) {
                setTimeout(initMap, 100);
                return;
            }
            var container = document.getElementById('map');
            var options = {
                center: new kakao.maps.LatLng(37.5665, 126.9780),
                level: 8
            };
            map = new kakao.maps.Map(container, options);
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initMap);
        } else {
            initMap();
        }
        
        function addWaypoint() {
            if (waypointCount >= 10) {
                alert('ê²½ìœ ì§€ëŠ” ìµœëŒ€ 10ê°œê¹Œì§€ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            waypointCount++;
            const container = document.getElementById('waypointContainer');
            const div = document.createElement('div');
            div.className = 'waypoint-group';
            div.id = `waypoint-${waypointCount}`;
            div.innerHTML = `
                <div class="waypoint-item">
                    <span class="waypoint-label">ê²½ìœ ì§€${waypointCount}</span>
                    <input type="text" class="waypoint-input" placeholder="ê²½ìœ ì§€ ì£¼ì†Œ ì…ë ¥">
                    <button onclick="removeWaypoint(${waypointCount})">ì‚­ì œ</button>
                </div>
            `;
            container.appendChild(div);
        }
        
        function removeWaypoint(id) {
            const element = document.getElementById(`waypoint-${id}`);
            if (element) {
                element.remove();
            }
        }
        
        async function calculateRoute() {
            const startAddr = document.getElementById('start').value.trim();
            const endAddr = document.getElementById('end').value.trim();
            const routeOption = document.getElementById('routeOption').value;
            
            if (!startAddr || !endAddr) {
                alert('ì¶œë°œì§€ì™€ ë„ì°©ì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ê²½ìœ ì§€ ìˆ˜ì§‘
            const waypointInputs = document.querySelectorAll('.waypoint-input');
            const waypoints = [];
            for (let input of waypointInputs) {
                if (input.value.trim()) {
                    waypoints.push(input.value.trim());
                }
            }
            
            // ì „ì²´ ê²½ë¡œ ìƒì„±
            const allPoints = [startAddr, ...waypoints, endAddr];
            
            try {
                // ê¸°ì¡´ ë§ˆì»¤/ì„  ì œê±°
                clearMap();
                
                // ì¢Œí‘œ ë³€í™˜
                const coords = [];
                for (let addr of allPoints) {
                    const coord = await getCoordinates(addr);
                    coords.push({ address: addr, ...coord });
                }
                
                if (routeOption === 'COMPARE') {
                    await compareAllRoutes(coords);
                } else {
                    await calculateSingleRoute(coords, routeOption);
                }
                
            } catch (error) {
                alert('ì˜¤ë¥˜: ' + error.message);
            }
        }
        
        async function calculateSingleRoute(coords, routeOption) {
            // êµ¬ê°„ë³„ ê²½ë¡œ ê³„ì‚° (ì„ íƒí•œ ì˜µì…˜ ì ìš©)
            const routes = [];
            let totalDistance = 0;
            let totalDuration = 0;
            let totalToll = 0;
            
            for (let i = 0; i < coords.length - 1; i++) {
                const routeData = await getRoute(coords[i], coords[i + 1], routeOption);
                const distance = routeData.summary.distance / 1000;
                const duration = routeData.summary.duration / 60;
                const toll = routeData.summary.fare?.toll || 0;
                const fuelCost = Math.floor(distance * PRICE_PER_KM / 10) * 10;
                
                routes.push({
                    from: coords[i].address,
                    to: coords[i + 1].address,
                    distance: distance.toFixed(2),
                    duration: Math.round(duration),
                    toll: toll,
                    fuelCost: fuelCost,
                    routeData: routeData
                });
                
                totalDistance += distance;
                totalDuration += duration;
                totalToll += toll;
            }
            
            const totalFuelCost = Math.floor(totalDistance * PRICE_PER_KM / 10) * 10;
            
            // ì§€ë„ì— í‘œì‹œ
            displayRoutes(coords, routes);
            
            // ê²°ê³¼ í‘œì‹œ
            displayResults(routes, totalDistance, totalDuration, totalToll, totalFuelCost, routeOption);
        }
        
        async function compareAllRoutes(coords) {
            const priorities = [
                { key: 'RECOMMEND', name: 'ì¶”ì²œ ê²½ë¡œ' },
                { key: 'TIME', name: 'ë¹ ë¥¸ ê¸¸' },
                { key: 'DISTANCE', name: 'ìµœë‹¨ ê±°ë¦¬' }
            ];
            
            const compareResults = [];
            
            for (const priority of priorities) {
                let totalDistance = 0;
                let totalDuration = 0;
                let totalToll = 0;
                const routes = [];
                
                for (let i = 0; i < coords.length - 1; i++) {
                    try {
                        const routeData = await getRoute(coords[i], coords[i + 1], priority.key);
                        const distance = routeData.summary.distance / 1000;
                        const duration = routeData.summary.duration / 60;
                        const toll = routeData.summary.fare?.toll || 0;
                        const fuelCost = Math.floor(distance * PRICE_PER_KM / 10) * 10;
                        
                        routes.push({
                            from: coords[i].address,
                            to: coords[i + 1].address,
                            distance: distance.toFixed(2),
                            duration: Math.round(duration),
                            toll: toll,
                            fuelCost: fuelCost,
                            routeData: routeData
                        });
                        
                        totalDistance += distance;
                        totalDuration += duration;
                        totalToll += toll;
                    } catch (error) {
                        console.error(`${priority.name} êµ¬ê°„ ê³„ì‚° ì‹¤íŒ¨:`, error);
                    }
                }
                
                const totalFuelCost = Math.floor(totalDistance * PRICE_PER_KM / 10) * 10;
                const totalCost = totalFuelCost + totalToll;
                
                compareResults.push({
                    name: priority.name,
                    distance: totalDistance.toFixed(2),
                    duration: Math.round(totalDuration),
                    toll: totalToll,
                    fuelCost: totalFuelCost,
                    totalCost: totalCost,
                    routes: routes
                });
            }
            
            if (compareResults.length > 0) {
                currentCompareResults = compareResults;
                currentCoords = coords;
                // ì¶”ì²œ ê²½ë¡œë¥¼ ì§€ë„ì— í‘œì‹œ
                displayRoutes(coords, compareResults[0].routes);
                displayCompareResults(compareResults, 0);
            }
        }
        
        function clearMap() {
            markers.forEach(marker => marker.setMap(null));
            polylines.forEach(polyline => polyline.setMap(null));
            markers = [];
            polylines = [];
        }
        
        async function getCoordinates(address) {
            let url = `https://dapi.kakao.com/v2/local/search/address.json?query=${encodeURIComponent(address)}`;
            let response = await fetch(url, {
                headers: { 'Authorization': `KakaoAK ${API_KEY}` }
            });
            let data = await response.json();
            
            if (data.documents && data.documents.length > 0) {
                return { 
                    x: parseFloat(data.documents[0].x), 
                    y: parseFloat(data.documents[0].y) 
                };
            }
            
            url = `https://dapi.kakao.com/v2/local/search/keyword.json?query=${encodeURIComponent(address)}`;
            response = await fetch(url, {
                headers: { 'Authorization': `KakaoAK ${API_KEY}` }
            });
            data = await response.json();
            
            if (data.documents && data.documents.length > 0) {
                return { 
                    x: parseFloat(data.documents[0].x), 
                    y: parseFloat(data.documents[0].y) 
                };
            }
            
            throw new Error('ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + address);
        }
        
        async function getRoute(start, end, priority = 'RECOMMEND') {
            const url = `https://apis-navi.kakaomobility.com/v1/directions?origin=${start.x},${start.y}&destination=${end.x},${end.y}&priority=${priority}`;
            
            const response = await fetch(url, {
                headers: { 'Authorization': `KakaoAK ${API_KEY}` }
            });
            
            const data = await response.json();
            
            if (!data.routes || data.routes.length === 0) {
                throw new Error('ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
            
            return data.routes[0];
        }
        
        function displayRoutes(coords, routes) {
            const bounds = new kakao.maps.LatLngBounds();
            
            // ë§ˆì»¤ í‘œì‹œ
            coords.forEach((coord, index) => {
                const position = new kakao.maps.LatLng(coord.y, coord.x);
                const marker = new kakao.maps.Marker({
                    position: position,
                    map: map,
                    label: index === 0 ? 'ì¶œë°œ' : index === coords.length - 1 ? 'ë„ì°©' : `${index}`
                });
                markers.push(marker);
                bounds.extend(position);
            });
            
            // ê²½ë¡œ ì„  ê·¸ë¦¬ê¸°
            routes.forEach(route => {
                const path = [];
                route.routeData.sections[0].roads.forEach(road => {
                    for (let i = 0; i < road.vertexes.length; i += 2) {
                        path.push(new kakao.maps.LatLng(
                            road.vertexes[i + 1],
                            road.vertexes[i]
                        ));
                    }
                });
                
                const polyline = new kakao.maps.Polyline({
                    path: path,
                    strokeWeight: 5,
                    strokeColor: '#FF0000',
                    strokeOpacity: 0.7,
                    strokeStyle: 'solid'
                });
                polyline.setMap(map);
                polylines.push(polyline);
            });
            
            map.setBounds(bounds);
        }
        
        function displayResults(routes, totalDistance, totalDuration, totalToll, totalFuelCost, routeOption = 'RECOMMEND') {
            const routeNames = {
                'RECOMMEND': 'ì¶”ì²œ ê²½ë¡œ',
                'TIME': 'ë¹ ë¥¸ ê¸¸',
                'DISTANCE': 'ìµœë‹¨ ê±°ë¦¬'
            };
            
            document.querySelector('#result h3').textContent = `ğŸ“ êµ¬ê°„ë³„ ìƒì„¸ ì •ë³´ (ğŸš— ${routeNames[routeOption]})`;
            
            let detailsHtml = '';
            routes.forEach((route, index) => {
                detailsHtml += `
                    <div class="route-detail">
                        <div class="route-detail-title">êµ¬ê°„ ${index + 1}: ${route.from} â†’ ${route.to}</div>
                        <div class="route-detail-info">
                            ê±°ë¦¬: ${route.distance}km | ì‹œê°„: ${route.duration}ë¶„ | í†µí–‰ë£Œ: ${route.toll.toLocaleString()}ì› | ìœ ë¥˜ë¹„: ${route.fuelCost.toLocaleString()}ì›
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('routeDetails').innerHTML = detailsHtml;
            document.getElementById('routeDetails').style.display = 'block';
            document.getElementById('compareResults').style.display = 'none';
            document.getElementById('totalDistance').textContent = `${totalDistance.toFixed(2)}km`;
            document.getElementById('totalDuration').textContent = `${Math.round(totalDuration)}ë¶„`;
            document.getElementById('totalToll').textContent = `${totalToll.toLocaleString()}ì›`;
            document.getElementById('totalFuelCost').textContent = `${totalFuelCost.toLocaleString()}ì›`;
            document.getElementById('result').style.display = 'block';
        }
        
        function displayCompareResults(compareResults, activeIndex = 0) {
            document.querySelector('#result h3').textContent = 'ğŸ“Š ê²½ë¡œ ì˜µì…˜ ë¹„êµ (í´ë¦­í•˜ì—¬ ê²½ë¡œ ë³€ê²½)';
            
            let html = '';
            compareResults.forEach((result, index) => {
                const activeClass = index === activeIndex ? 'active' : '';
                html += `
                    <div class="compare-card ${activeClass}" onclick="selectMultiRoute(${index})">
                        <h4>ğŸš— ${result.name}</h4>
                        <p>ê±°ë¦¬: ${result.distance}km | ì‹œê°„: ${result.duration}ë¶„</p>
                        <p>í†µí–‰ë£Œ: ${result.toll.toLocaleString()}ì› | ìœ ë¥˜ë¹„: ${result.fuelCost.toLocaleString()}ì›</p>
                        <p style="font-weight: bold; color: #e91e63;">ì´ ë¹„ìš©: ${result.totalCost.toLocaleString()}ì›</p>
                    </div>
                `;
            });
            
            const minCost = Math.min(...compareResults.map(r => r.totalCost));
            const minTime = Math.min(...compareResults.map(r => r.duration));
            const minCostRoute = compareResults.find(r => r.totalCost === minCost);
            const minTimeRoute = compareResults.find(r => r.duration === minTime);
            
            html += `
                <div class="compare-summary">
                    <div>ğŸ’° ìµœì € ë¹„ìš©: ${minCostRoute.name} (${minCost.toLocaleString()}ì›)</div>
                    <div>âš¡ ìµœë‹¨ ì‹œê°„: ${minTimeRoute.name} (${minTime}ë¶„)</div>
                </div>
            `;
            
            document.getElementById('compareResults').innerHTML = html;
            document.getElementById('routeDetails').style.display = 'none';
            document.getElementById('compareResults').style.display = 'block';
            
            // ì„ íƒëœ ê²½ë¡œì˜ ì´ê³„ í‘œì‹œ
            const selectedRoute = compareResults[activeIndex];
            document.getElementById('totalDistance').textContent = `${selectedRoute.distance}km`;
            document.getElementById('totalDuration').textContent = `${selectedRoute.duration}ë¶„`;
            document.getElementById('totalToll').textContent = `${selectedRoute.toll.toLocaleString()}ì›`;
            document.getElementById('totalFuelCost').textContent = `${selectedRoute.fuelCost.toLocaleString()}ì›`;
            
            document.getElementById('result').style.display = 'block';
        }
        
        function selectMultiRoute(index) {
            if (currentCompareResults && currentCoords) {
                const selectedRoute = currentCompareResults[index];
                clearMap();
                displayRoutes(currentCoords, selectedRoute.routes);
                displayCompareResults(currentCompareResults, index);
            }
        }
    </script>
</body>
</html>
